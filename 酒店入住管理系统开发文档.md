# 酒店入住管理系统开发文档

## 一、项目概述

### 1.1 项目简介

酒店入住管理系统是一个基于 Django 4.2 框架开发的 Web 应用系统，采用 Django Admin + SimpleUI 作为管理后台，实现了酒店日常运营管理的核心功能。系统的设计重点在于业务流程的自动化，特别是预订管理与财务管理的联动。

### 1.2 核心特性

- **自动化业务流程**: 预订创建自动记录收入，退订自动处理退款
- **智能状态管理**: 房间状态根据预订情况实时自动更新
- **金额自动计算**: 根据入住天数和房间价格自动计算应付金额
- **数据完整性保护**: 多层次的数据验证和业务规则检查
- **删除保护机制**: 防止误删除活跃数据，保证数据安全

### 1.3 技术栈

| 技术组件 | 说明 |
|---------|------|
| Python 3.9+ | 编程语言 |
| Django 4.2 | Web框架，提供ORM、Admin等核心功能 |
| MySQL 8.0+ | 关系型数据库 |
| django-simpleui | Django Admin美化插件 |
| Pillow | 图片处理库，支持房间图片上传 |
| PyMySQL/mysqlclient | Python MySQL驱动 |


## 二、系统架构设计

### 2.1 整体架构

```
┌─────────────────────────────────────────────────────────┐
│                    用户界面层 (UI Layer)                  │
│                  Django Admin + SimpleUI                 │
└────────────────────────┬────────────────────────────────┘
                         │
┌────────────────────────┴────────────────────────────────┐
│                   业务逻辑层 (Business Layer)             │
│  ┌──────────┬──────────┬───────────┬──────────┬───────┐ │
│  │  rooms   │customers │reservation│  finance │employ │ │
│  │ 房间管理  │ 客户管理  │ 预订管理   │ 财务管理  │员工管理│ │
│  └──────────┴──────────┴───────────┴──────────┴───────┘ │
└────────────────────────┬────────────────────────────────┘
                         │
┌────────────────────────┴────────────────────────────────┐
│                 数据持久层 (Data Layer)                   │
│                     Django ORM + MySQL                   │
└─────────────────────────────────────────────────────────┘
```

### 2.2 核心业务流程

```
创建预订
    ↓
数据验证 (clean方法)
    ├─ 日期有效性检查（入住日期 < 离店日期）
    ├─ 金额自动计算（天数 × 房间价格）
    ├─ 人数容量检查（不超过房间容量）
    └─ 日期冲突检测（同房间时间段重叠）
    ↓
保存到数据库 (save方法)
    ↓
触发自动化流程
    ├─ 更新房间状态 (_update_room_status)
    ├─ 创建收入记录 (_create_income_record)
    └─ 处理退款 (_process_refund)
```


## 三、数据模型设计

### 3.1 Room (房间模型)

**文件位置**: `rooms/models.py`

**职责**: 管理酒店房间的基本信息和状态

**字段定义**:

```python
# 房间号验证器：必须为3位数字
room_number_validator = RegexValidator(regex=r'^\d{3}$', message='房间号必须是三位数字，如：101、202、303')

class Room(models.Model):
    """ 房间模型 - 存储房间基本信息、类型、价格、状态等"""
    ROOM_TYPES = (('Single', '单人间'), ('Double', '双人间'), ('Suite', '套房'), ('Deluxe', '豪华间'))
    ROOM_STATUS = (('Available', '空闲'), ('Booked', '已预订'), ('Occupied', '已入住'), ('Maintenance', '维修中'))

    room_number = models.CharField(max_length=3, unique=True, verbose_name='房间号', validators=[room_number_validator])
    room_type = models.CharField(max_length=50, choices=ROOM_TYPES, verbose_name='房间类型')
    price = models.PositiveIntegerField(verbose_name='价格', validators=[MinValueValidator(1)])
    facilities = models.TextField(verbose_name='设施')
    status = models.CharField(max_length=20, choices=ROOM_STATUS, default='Available', verbose_name='状态')
    floor = models.IntegerField(verbose_name='楼层')
    capacity = models.IntegerField(verbose_name='容纳人数')
    description = models.TextField(blank=True, verbose_name='描述')
    pictures = models.ImageField(upload_to='pictures/', blank=True, null=True, verbose_name='房间主图')

    def clean(self):
        super().clean()
        if self.price is not None and self.price <= 0:
            raise ValidationError({'price': '价格必须为正整数'})
```

**状态流转**:
- `Available` → `Booked`: 创建预订时
- `Booked` → `Occupied`: 办理入住时
- `Occupied` → `Available`: 办理退房时
- `Maintenance`: 手动设置，系统不自动修改

**业务规则**:
1. 房间号必须为3位数字（如：101、202、303）
2. 房间状态由预订系统自动维护，维修中状态需手动设置
3. 房间价格必须 ≥ 1
4. 有活跃订单的房间不能删除或修改


### 3.2 Customer (客户模型)

**文件位置**: `customers/models.py`

**职责**: 管理客户基本信息

**字段定义**:

```python
# 手机号验证器
phone_validator = RegexValidator(regex=r'^1[3-9]\d{9}$', message='请输入有效的11位手机号')

def validate_id_number(value):
    """验证18位身份证号格式"""
    pattern = r'^[1-9]\d{5}(19|20)\d{2}(0[1-9]|1[0-2])(0[1-9]|[12]\d|3[01])\d{3}[\dXx]$'
    if not re.match(pattern, value):
        raise ValidationError('请输入有效的18位身份证号')

class Customer(models.Model):
    """客户模型 - 存储客户基本信息"""
    name = models.CharField(max_length=100, verbose_name='姓名')
    id_number = models.CharField(max_length=18, unique=True, verbose_name='身份证号', validators=[validate_id_number])
    phone = models.CharField(max_length=11, verbose_name='联系方式', validators=[phone_validator])
    email = models.EmailField(blank=True, verbose_name='邮箱')
    address = models.TextField(blank=True, verbose_name='地址')
```

**业务规则**:
1. 身份证号必须为有效的18位格式，全局唯一
2. 手机号必须为有11位格式（1开头）
3. 存在活跃订单的客户不能删除
4. 存在已入住订单的客户不能修改信息


### 3.3 Reservation (预订模型) - 核心模型

**文件位置**: `reservations/models.py`

**职责**: 管理预订全生命周期，协调房间和财务系统

**字段定义**:

```python
class Reservation(models.Model):
    STATUS = (
        ('Booked', '已预定'),
        ('CheckedIn', '已入住'),
        ('CheckedOut', '已离店'),
        ('Refunded', '已退订')
    )
    
    customer = models.ForeignKey(Customer, on_delete=models.CASCADE, verbose_name='客户')
    room = models.ForeignKey(Room, on_delete=models.CASCADE, verbose_name='房间')
    check_in_date = models.DateField(verbose_name='入住日期')
    check_out_date = models.DateField(verbose_name='离店日期')
    number_of_guests = models.PositiveIntegerField(verbose_name='入住人数',
        validators=[MinValueValidator(1), MaxValueValidator(100)])
    special_requests = models.TextField(blank=True, verbose_name='特殊要求')
    status = models.CharField(max_length=20, choices=STATUS, default='Booked', verbose_name='预订状态')
    paid_amount = models.DecimalField(max_digits=10, decimal_places=2, default=0, verbose_name='已付金额',
        validators=[MinValueValidator(Decimal('0.00'))])
    income_recorded = models.BooleanField(default=False, verbose_name='已记录收入')
    refund_recorded = models.BooleanField(default=False, verbose_name='已退款')
    refund_amount = models.DecimalField(max_digits=10, decimal_places=2, default=0, verbose_name='退款金额',
        validators=[MinValueValidator(Decimal('0.00'))])
    created_at = models.DateTimeField(auto_now_add=True, verbose_name='创建时间')
    updated_at = models.DateTimeField(auto_now=True, verbose_name='更新时间')
```

**状态流转**:

```
Booked (已预定)
    ├─→ CheckedIn (已入住) ─→ CheckedOut (已离店)
    └─→ Refunded (已退订)
```

**核心方法**:

#### 1. clean() - 数据验证

```python
def clean(self):
    super().clean()
    # 1. 验证入住日期早于离店日期
    if self.check_in_date >= self.check_out_date:
        raise ValidationError('入住日期必须早于离店日期')
    
    # 2. 自动计算金额
    days = (self.check_out_date - self.check_in_date).days
    self.paid_amount = Decimal(str(days)) * self.room.price
    
    # 3. 验证入住人数不超过房间容量
    if self.number_of_guests > self.room.capacity:
        raise ValidationError(f'人数({self.number_of_guests})超过房间容量({self.room.capacity})')
    
    # 4. 日期冲突检测
    conflict = Reservation.objects.filter(
        room=self.room, status__in=['Booked', 'CheckedIn']
    ).filter(
        Q(check_in_date__lt=self.check_out_date) & Q(check_out_date__gt=self.check_in_date)
    )
    if self.pk:
        conflict = conflict.exclude(pk=self.pk)
    if conflict.exists():
        raise ValidationError(f'房间{self.room.room_number}该时段已被预订')
```

#### 2. save() - 保存处理

```python
def save(self, *args, **kwargs):
    self.full_clean()  # 执行验证
    
    # 超期自动离店
    if self.check_out_date < date.today() and self.status == 'CheckedIn':
        self.status = 'CheckedOut'
    
    is_new = self.pk is None
    old_status = None if is_new else Reservation.objects.get(pk=self.pk).status
    
    super().save(*args, **kwargs)
    
    self._update_room_status()  # 同步房间状态
    
    if self.paid_amount > 0 and not self.income_recorded:
        self._create_income_record()  # 创建收入记录
    
    if not is_new and old_status != 'Refunded' and self.status == 'Refunded':
        self._process_refund()  # 处理退款
```

#### 3. _update_room_status() - 房间状态同步

```python
def _update_room_status(self):
    active = Reservation.objects.filter(room=self.room, status__in=['Booked', 'CheckedIn'])
    
    if active.filter(status='CheckedIn').exists():
        new_status = 'Occupied'
    elif active.filter(status='Booked').exists():
        new_status = 'Booked'
    else:
        new_status = 'Available' if self.room.status != 'Maintenance' else 'Maintenance'
    
    if self.room.status != new_status:
        self.room.status = new_status
        self.room.save()
```

#### 4. _create_income_record() - 创建收入记录

```python
def _create_income_record(self):
    from finance.models import Income
    
    days = (self.check_out_date - self.check_in_date).days
    description = (
        f'预订号:{self.id}|客户:{self.customer.name}|房间:{self.room.room_number}|'
        f'{self.check_in_date}至{self.check_out_date}({days}天)|人数:{self.number_of_guests}'
    )
    
    Income.objects.create(
        date=timezone.now().date(),
        amount=self.paid_amount,
        source='Room',
        description=description
    )
    
    Reservation.objects.filter(pk=self.pk).update(income_recorded=True)
```

#### 5. _process_refund() - 退款处理

```python
def _process_refund(self):
    if self.refund_recorded or self.paid_amount <= 0:
        return
    
    from finance.models import Income, Expense
    
    self.refund_amount = self.paid_amount  # 全额退款
    
    # 创建退款支出记录
    Expense.objects.create(
        date=timezone.now().date(),
        amount=self.refund_amount,
        category='Other',
        description=f'退款-预订号:{self.id}|客户:{self.customer.name}|退款:￥{self.refund_amount}'
    )
    
    # 标记原收入记录
    if self.income_recorded:
        income = Income.objects.filter(source='Room', description__contains=f'预订号:{self.id}').first()
        if income:
            income.description += f'|[已退订-退款￥{self.refund_amount}]'
            income.save()
    
    Reservation.objects.filter(pk=self.pk).update(refund_recorded=True, refund_amount=self.refund_amount)
```

#### 6. delete() - 删除处理

```python
def delete(self, *args, **kwargs):
    room = self.room
    
    if self.paid_amount > 0 and not self.refund_recorded:
        self._process_refund()
    
    if self.income_recorded:
        income = Income.objects.filter(source='Room', description__contains=f'预订号:{self.id}').first()
        if income:
            income.description += '|[预订已删除]'
            income.save()
    
    super().delete(*args, **kwargs)
    
    # 重新评估房间状态
    # ... (同 _update_room_status 逻辑)
```


### 3.4 Income (收入模型)

**文件位置**: `finance/models.py`

**字段定义**:

```python
class Income(models.Model):
    """收入模型 - 记录酒店所有收入，包括客房收入、餐饮收入等"""
    INCOME_SOURCES = (('Room', '客房收入'), ('Food', '餐饮收入'), ('Other', '其他收入'))

    date = models.DateField(verbose_name='日期')
    amount = models.PositiveIntegerField(verbose_name='金额', validators=[MinValueValidator(1)])
    source = models.CharField(max_length=50, choices=INCOME_SOURCES, verbose_name='收入来源')
    description = models.TextField(blank=True, verbose_name='描述')

    def clean(self):
        super().clean()
        if self.amount is not None and self.amount <= 0:
            raise ValidationError({'amount': '金额必须为正整数'})
```


### 3.5 Expense (支出模型)

**文件位置**: `finance/models.py`

**字段定义**:

```python
class Expense(models.Model):
    """支出模型 - 记录酒店所有支出，包括工资、维修、水电等"""
    EXPENSE_CATEGORIES = (('Salary', '员工工资'), ('Maintenance', '维修费用'), ('Utilities', '水电费'), ('Other', '其他支出'))

    date = models.DateField(verbose_name='日期')
    amount = models.PositiveIntegerField(verbose_name='金额', validators=[MinValueValidator(1)])
    category = models.CharField(max_length=50, choices=EXPENSE_CATEGORIES, verbose_name='支出类别')
    description = models.TextField(blank=True, verbose_name='描述')

    def clean(self):
        super().clean()
        if self.amount is not None and self.amount <= 0:
            raise ValidationError({'amount': '金额必须为正整数'})
```


### 3.6 Employee (员工模型)

**文件位置**: `employees/models.py`

**字段定义**:

```python
# 手机号验证器
phone_validator = RegexValidator(regex=r'^1[3-9]\d{9}$', message='请输入有效的11位手机号')

class Employee(models.Model):
    """员工模型 - 存储员工基本信息、职位、薪资等"""
    POSITION_CHOICES = (('前台', '前台'), ('后厨', '后厨'), ('保洁', '保洁'), ('保安', '保安'), ('经理', '经理'))
    STATUS_CHOICES = (('在职', '在职'), ('离职', '离职'))

    name = models.CharField(max_length=100, verbose_name='姓名')
    position = models.CharField(max_length=100, choices=POSITION_CHOICES, verbose_name='职位')
    phone = models.CharField(max_length=11, verbose_name='联系方式', validators=[phone_validator])
    email = models.EmailField(blank=True, verbose_name='邮箱')
    address = models.TextField(blank=True, verbose_name='地址')
    salary = models.PositiveIntegerField(verbose_name='工资', validators=[MinValueValidator(1)])
    hire_date = models.DateField(verbose_name='入职日期')
    status = models.CharField(max_length=20, choices=STATUS_CHOICES, default='在职', verbose_name='状态')

    def clean(self):
        """验证工资必须为正整数"""
        super().clean()
        if self.salary is not None and self.salary <= 0:
            raise ValidationError({'salary': '工资必须为正整数'})
```


## 四、Admin 配置

### 4.1 ReservationAdmin 配置

**文件位置**: `reservations/admin.py`

**主要特性**:

1. **自定义表单 (ReservationAdminForm)**:
   - 新建预订：只显示空闲房间，状态限制为「已预定」或「已入住」
   - 编辑预订：显示空闲房间+当前房间，已离店/已退订订单状态禁用
   - 已入住订单不能修改客户和房间，不支持退款

2. **列表显示**:
   - 彩色状态标签（预订状态、房间状态）
   - 金额格式化显示（绿色已付，红色退款）

3. **批量操作 (actions)**:
   - `make_checkin`: 批量办理入住
   - `make_checkout`: 批量办理离店
   - `cancel_reservations`: 批量退订(自动退款，已入住订单不支持)
   - `safe_delete_selected`: 安全删除(检查活跃订单)

4. **删除保护**:
   - 活跃订单（已预定/已入住）无法删除
   - 使用 `ValidationError` 提供友好错误提示

### 4.2 RoomAdmin 配置

**文件位置**: `rooms/admin.py`

**主要特性**:

1. **图片预览**: 使用 lightbox2 实现图片点击放大
2. **彩色状态标签**: 不同状态显示不同颜色
3. **删除保护**: 有活跃订单的房间无法删除
4. **修改保护**: 有活跃订单的房间无法修改信息
5. **安全删除**: 替换默认删除操作，检查活跃订单后执行

### 4.3 CustomerAdmin 配置

**文件位置**: `customers/admin.py`

**主要特性**:

1. **邮箱高亮显示**: 蓝色显示邮箱地址
2. **删除保护**: 有活跃订单的客户无法删除
3. **修改保护**: 有已入住订单的客户无法修改信息
4. **安全删除**: 替换默认删除操作，检查活跃订单后执行


## 五、配置说明

### 5.1 数据库配置 (settings.py)

```python
DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.mysql',
        'NAME': 'hotel_management_db',
        'USER': 'root',
        'PASSWORD': 'admin',  # 修改为实际密码
        'HOST': 'localhost',
        'PORT': '3306',
    }
}
```

### 5.2 SimpleUI 配置 (settings.py)

```python
SIMPLEUI_LOGO = '/static/img/logo.png'
SIMPLEUI_HOME_INFO = False
SIMPLEUI_ANALYSIS = False
SIMPLEUI_DEFAULT_THEME = 'admin.lte.css'

SIMPLEUI_CONFIG = {
    'system_keep': False,
    'menu_display': ['酒店管理', '财务管理', '员工管理', '系统管理'],
    'menus': [
        {
            'name': '酒店管理',
            'icon': 'fas fa-user-shield',
            'models': [
                {'name': '房间管理', 'url': 'rooms/room/'},
                {'name': '顾客管理', 'url': 'customers/customer/'},
                {'name': '预定管理', 'url': 'reservations/reservation/'}
            ]
        },
        # ... 其他菜单配置
    ]
}
```

### 5.3 媒体文件配置

```python
MEDIA_URL = '/media/'
MEDIA_ROOT = os.path.join(BASE_DIR, 'media')
```

房间图片上传至 `media/pictures/` 目录


## 六、开发规范

### 6.1 代码规范

1. 所有模型必须包含 `__str__` 方法
2. 所有模型必须定义 `verbose_name` 和 `verbose_name_plural`
3. 金额字段统一使用 `PositiveIntegerField`，配合 `MinValueValidator(1)`
4. 手机号、身份证号等字段使用 `RegexValidator` 进行格式验证
4. 验证逻辑写在 `clean()` 方法中
5. 自动化逻辑写在 `save()` 方法中

### 6.2 注释规范

1. 每个文件开头添加模块说明（docstring）
2. 每个类添加 docstring 说明
3. 每个方法添加 docstring 说明
4. 关键业务逻辑添加行内注释

### 6.3 数据库规范

1. 外键使用 `CASCADE` 级联删除
2. 唯一字段使用 `unique=True`
3. 可选字段设置 `blank=True`
4. 避免使用 `FloatField` 存储金额


## 七、测试要点

### 7.1 功能测试

| 测试项 | 验证点 |
|--------|--------|
| 预订创建 | 金额自动计算、收入记录创建、房间状态更新 |
| 日期冲突 | 同房间时段重叠时拒绝创建 |
| 退订流程 | 退款记录创建、原收入标记、房间状态更新 |
| 入住/退房 | 房间状态正确同步 |

### 7.2 边界测试

| 测试项 | 场景 |
|--------|------|
| 入住天数 | 1天（最小值） |
| 入住人数 | 等于房间容量上限 |
| 金额输入 | 0或负数输入（应拒绝） |
| 日期输入 | 日期倒序（入住>离店，应拒绝） |
| 房间号 | 非3位数字（应拒绝） |
| 手机号 | 非11位格式（应拒绝） |
| 身份证号 | 非18位有效格式（应拒绝） |

### 7.3 删除保护测试

| 测试项 | 预期结果 |
|--------|----------|
| 删除有活跃订单的客户 | 拒绝删除，显示错误提示 |
| 删除有活跃订单的房间 | 拒绝删除，显示错误提示 |
| 删除活跃订单 | 拒绝删除，显示错误提示 |
| 修改有活跃订单的房间 | 拒绝修改，显示错误提示 |
| 修改有已入住订单的客户 | 拒绝修改，显示错误提示 |


## 八、常见问题

### Q1: 金额显示为0

**原因**: 未选择房间或日期不正确  
**解决**: 确保入住日期早于离店日期，且已选择房间

### Q2: 无法删除客户/房间

**原因**: 存在活跃订单（已预定或已入住状态）  
**解决**: 先将相关订单改为已离店或已退订

### Q3: 房间状态未更新

**原因**: 房间号格式不正确  
**解决**: 房间号必须为3位数字，如：101、202、303

### Q5: 无法修改客户/房间信息

**原因**: 存在活跃订单（客户有已入住订单，或房间有已预定/已入住订单）  
**解决**: 先将相关订单改为已离店或已退订

### Q6: 手机号/身份证号验证失败

**原因**: 格式不正确  
**解决**: 手机号必须为11位（1开头），身份证号必须为有18位格式

### Q4: 退款未生成

**原因**: 订单状态未正确修改为已退订  
**解决**: 确保状态改为"已退订"并保存


## 九、扩展建议

### 9.1 功能扩展

- 增加房间类型管理（独立模型）
- 增加会员等级和折扣功能
- 增加订单统计和报表功能
- 增加短信/邮件通知功能

### 9.2 性能优化

- 使用 `select_related` 减少数据库查询
- 增加缓存机制
- 优化 Admin 列表查询

### 9.3 安全增强

- 增加操作日志审计
- 增加权限细分（不同角色不同权限）
- 增加数据自动备份机制
