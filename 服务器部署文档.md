# 酒店入住管理系统 - CentOS 7.9 服务器部署文档

## 目录

- [一、服务器环境信息](#一服务器环境信息)
- [二、部署前准备](#二部署前准备)
- [三、安装 MySQL 数据库](#三安装-mysql-数据库)
- [四、配置 MySQL 数据库](#四配置-mysql-数据库)
- [五、上传项目文件](#五上传项目文件)
- [六、安装 Python 环境](#六安装-python-环境)
- [七、修改项目配置](#七修改项目配置)
- [八、配置 Gunicorn 服务](#八配置-gunicorn-服务)
- [九、配置 Nginx 反向代理](#九配置-nginx-反向代理)
- [十、云服务器安全组配置](#十云服务器安全组配置)
- [十一、访问测试](#十一访问测试)
- [十二、常见问题与解决方案](#十二常见问题与解决方案)
- [十三、运维命令速查](#十三运维命令速查)

---

## 一、服务器环境信息

| 项目 | 配置 |
|------|------|
| 实例名称 | CentOS-7.9 |
| 实例规格 | CPU 2核 / 内存 2GB |
| 系统盘 | 40GB 通用型SSD |
| 公网IP | 117.72.39.127 |
| 内网IP | 172.16.0.5 |
| 流量包 | 200GB/月 |
| 带宽上限 | 3Mbps |

---

## 二、部署前准备

### 2.1 连接服务器

使用 SSH 客户端（如 Xshell、PuTTY）连接服务器：

```bash
ssh root@117.72.39.127
```

### 2.2 更新系统并安装基础工具

```bash
# 更新系统包
yum update -y

# 安装开发工具和常用依赖
yum groupinstall -y "Development Tools"
yum install -y epel-release
yum install -y vim wget unzip lrzsz
```

> **说明**：`lrzsz` 是用于在 Xshell 中通过 `rz`（上传）和 `sz`（下载）命令传输文件的工具。

---

## 三、安装 MySQL 数据库

### 3.1 添加 MySQL 官方仓库

```bash
yum install -y https://dev.mysql.com/get/mysql57-community-release-el7-11.noarch.rpm
```

### 3.2 安装 MySQL 服务器

```bash
yum install -y mysql-community-server
```

#### ⚠️ 问题：GPG 密钥验证失败

**错误信息**：
```
Public key for mysql-community-libs-5.7.44-1.el7.x86_64.rpm is not installed
Failing package is: mysql-community-libs-5.7.44-1.el7.x86_64
GPG Keys are configured as: file:///etc/pki/rpm-gpg/RPM-GPG-KEY-mysql
```

**解决方案**：

方法一：导入新的 GPG 密钥
```bash
rpm --import https://repo.mysql.com/RPM-GPG-KEY-mysql-2022
yum install -y mysql-community-server
```

方法二：跳过 GPG 检查安装（如果方法一失败）
```bash
yum install -y mysql-community-server --nogpgcheck
```

### 3.3 启动 MySQL 服务

```bash
# 启动 MySQL
systemctl start mysqld

# 设置开机自启
systemctl enable mysqld

# 查看服务状态
systemctl status mysqld
```

---

## 四、配置 MySQL 数据库

### 4.1 获取 MySQL 临时密码

MySQL 5.7 安装后会生成一个临时密码，通过以下命令获取：

```bash
grep 'temporary password' /var/log/mysqld.log
```

输出示例：
```
2025-12-13T15:44:35.235765Z 1 [Note] A temporary password is generated for root@localhost: _nPC9mV4vXx+
```

> 临时密码为：`_nPC9mV4vXx+`（每次安装不同）

### 4.2 登录并修改密码

```bash
mysql -u root -p
# 输入上面获取的临时密码
```

在 MySQL 命令行中执行：

```sql
-- 修改 root 密码（密码需包含大小写字母、数字、特殊字符）
ALTER USER 'root'@'localhost' IDENTIFIED BY 'Admin@123';

-- 创建项目数据库
CREATE DATABASE hotel_management_db CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

-- 查看数据库
SHOW DATABASES;

-- 退出
EXIT;
```

### 4.3 导入数据库结构

```bash
mysql -u root -p'Admin@123' hotel_management_db < /root/hotel_management_db.sql
```

> **注意**：命令行中使用密码时会显示警告 `Using a password on the command line interface can be insecure`，这只是安全提示，不影响操作。

---

## 五、上传项目文件

### 5.1 创建项目目录

```bash
mkdir -p /var/www/hotel_management
```

### 5.2 使用 Xshell + rz 命令上传

#### 上传 SQL 文件

```bash
cd /root
rz
# 弹出文件选择窗口，选择 hotel_management_db.sql
```

#### 上传项目压缩包

在本地电脑上，将 `hotel_management` 文件夹压缩为 `hotel_management.zip`，然后：

```bash
cd /var/www/hotel_management
rz
# 选择 hotel_management.zip
```

### 5.3 解压项目文件

```bash
cd /var/www/hotel_management
unzip hotel_management.zip
ls -la
```

解压后目录结构：
```
/var/www/hotel_management/
├── customers/
├── employees/
├── finance/
├── hotel_management/
├── media/
├── reservations/
├── rooms/
├── static/
├── templates/
├── manage.py
└── requirements.txt
```

---

## 六、安装 Python 环境

### 6.1 安装 Python 3 和相关依赖

```bash
yum install -y python3 python3-devel python3-pip mysql-devel gcc
```

### 6.2 创建虚拟环境

```bash
cd /var/www/hotel_management

# 创建虚拟环境
python3 -m venv venv

# 激活虚拟环境
source venv/bin/activate
```

> 激活后命令提示符会显示 `(venv)`

### 6.3 安装项目依赖

```bash
# 升级 pip
pip install --upgrade pip

# 安装依赖
pip install -r requirements.txt
```

#### ⚠️ 问题：pip 下载超时

**错误信息**：
```
pip._vendor.urllib3.exceptions.ReadTimeoutError: HTTPSConnectionPool(host='files.pythonhosted.org', port=443): Read timed out.
```

**解决方案**：使用国内镜像源

```bash
pip install -r requirements.txt -i https://mirrors.aliyun.com/pypi/simple/ --trusted-host mirrors.aliyun.com
```

### 6.4 安装生产环境服务器

```bash
pip install gunicorn -i https://mirrors.aliyun.com/pypi/simple/ --trusted-host mirrors.aliyun.com
```

---

## 七、修改项目配置

### 7.1 编辑 settings.py

```bash
vi /var/www/hotel_management/hotel_management/settings.py
```

### 7.2 需要修改的配置项

#### 1) 关闭调试模式（第 39 行左右）

```python
DEBUG = False
```

#### 2) 配置允许的主机（第 44 行左右）

```python
ALLOWED_HOSTS = ['117.72.39.127', 'localhost', '127.0.0.1', '*']
```

#### 3) 修改数据库密码（第 125 行左右）

```python
DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.mysql',
        'NAME': 'hotel_management_db',
        'USER': 'root',
        'PASSWORD': 'Admin@123',  # 修改为你设置的密码
        'HOST': 'localhost',
        'PORT': '3306',
    }
}
```

#### 4) 添加静态文件收集目录（在 STATIC_URL 后添加）

找到 `STATIC_URL = '/static/'`（约第 168 行），在其后添加：

```python
STATIC_ROOT = os.path.join(BASE_DIR, 'staticfiles')
```

### 7.3 收集静态文件

```bash
cd /var/www/hotel_management
source venv/bin/activate
python manage.py collectstatic --noinput
```

### 7.4 测试运行

```bash
python manage.py runserver 0.0.0.0:8000
```

看到以下输出表示成功：
```
Starting development server at http://0.0.0.0:8000/
Quit the server with CONTROL-C.
```

按 `Ctrl+C` 停止测试服务器。

---

## 八、配置 Gunicorn 服务

### 8.1 创建 systemd 服务文件

```bash
cat > /etc/systemd/system/hotel.service << 'EOF'
[Unit]
Description=Hotel Management Django App
After=network.target

[Service]
User=root
Group=root
WorkingDirectory=/var/www/hotel_management
ExecStart=/var/www/hotel_management/venv/bin/gunicorn --workers 2 --bind 0.0.0.0:8000 hotel_management.wsgi:application

[Install]
WantedBy=multi-user.target
EOF
```

### 8.2 启动服务

```bash
# 重新加载 systemd 配置
systemctl daemon-reload

# 启动服务
systemctl start hotel

# 设置开机自启
systemctl enable hotel

# 查看服务状态
systemctl status hotel
```

正常输出：
```
● hotel.service - Hotel Management Django App
   Loaded: loaded (/etc/systemd/system/hotel.service; enabled)
   Active: active (running)
   ...
   Listening at: http://0.0.0.0:8000
```

---

## 九、配置 Nginx 反向代理

### 9.1 为什么需要 Nginx？

Django 在生产环境不会自动提供静态文件服务，需要 Nginx 来：
1. 提供静态文件（CSS、JS、图片）服务
2. 反向代理到 Gunicorn
3. 处理高并发请求

### 9.2 安装 Nginx

```bash
yum install -y nginx
```

### 9.3 创建 Nginx 配置文件

```bash
cat > /etc/nginx/conf.d/hotel.conf << 'EOF'
server {
    listen 80;
    server_name 117.72.39.127;

    # 静态文件
    location /static/ {
        alias /var/www/hotel_management/staticfiles/;
    }

    # 媒体文件（用户上传的图片等）
    location /media/ {
        alias /var/www/hotel_management/media/;
    }

    # 反向代理到 Gunicorn
    location / {
        proxy_pass http://127.0.0.1:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
}
EOF
```

### 9.4 修改 Gunicorn 端口

由于 Nginx 占用 80 端口，Gunicorn 需要改为内部端口 8000：

```bash
# 确保 hotel.service 中是 8000 端口
cat /etc/systemd/system/hotel.service | grep bind
# 应显示: --bind 0.0.0.0:8000
```

### 9.5 启动 Nginx

```bash
# 测试配置文件语法
nginx -t

# 启动 Nginx
systemctl start nginx

# 设置开机自启
systemctl enable nginx

# 查看状态
systemctl status nginx
```

### 9.6 重启所有服务

```bash
systemctl restart hotel
systemctl restart nginx
```

---

## 十、云服务器安全组配置

### 10.1 需要开放的端口

在云服务器控制台的 **安全组** 或 **防火墙规则** 中，添加以下入站规则：

| 端口 | 协议 | 来源 | 说明 |
|------|------|------|------|
| 80 | TCP | 0.0.0.0/0 | HTTP 访问 |
| 443 | TCP | 0.0.0.0/0 | HTTPS 访问（可选） |
| 22 | TCP | 0.0.0.0/0 | SSH 远程连接 |
| 3306 | TCP | 指定IP | MySQL（建议仅允许特定IP） |

#### ⚠️ 问题：无法访问网站，连接超时

**错误信息**：
```
Firefox 无法建立到 117.72.39.127 服务器的连接
```

**原因**：云服务器安全组未开放对应端口

**解决方案**：
1. 登录云服务器控制台
2. 找到实例的「安全组」设置
3. 添加入站规则，开放 80 端口（或 8000 端口）

---

## 十一、访问测试

### 11.1 访问地址

- **管理后台**：http://117.72.39.127/admin/
- **默认账户**：
  - 用户名：`admin`
  - 密码：`admin`

### 11.2 验证静态文件

访问后台，如果页面样式正常显示（有 SimpleUI 美化效果），说明静态文件配置成功。

---

## 十二、常见问题与解决方案

### 问题 1：DisallowedHost 错误

**错误信息**：
```
DisallowedHost at /admin/
Invalid HTTP_HOST header: '117.72.39.127'. You may need to add '117.72.39.127' to ALLOWED_HOSTS.
```

**解决方案**：
编辑 `settings.py`，确保 `ALLOWED_HOSTS` 包含服务器 IP：
```python
ALLOWED_HOSTS = ['117.72.39.127', 'localhost', '127.0.0.1', '*']
```

---

### 问题 2：数据库连接失败

**错误信息**：
```
MySQLdb.OperationalError: (1045, "Access denied for user 'root'@'localhost' (using password: YES)")
```

**解决方案**：
1. 确认 `settings.py` 中的数据库密码正确
2. 测试数据库连接：
   ```bash
   mysql -u root -p'Admin@123' -e "SELECT 1;"
   ```

---

### 问题 3：页面白屏，静态文件 404

**错误日志**：
```
Not Found: /static/admin/simpleui-x/elementui/umd/locale/en.js
Not Found: /static/admin/simpleui-x/js/index.js
```

**原因**：
1. 未配置 `STATIC_ROOT`
2. 未执行 `collectstatic`
3. Nginx 未正确配置静态文件路径

**解决方案**：
```bash
# 1. 确保 settings.py 中有 STATIC_ROOT
grep STATIC_ROOT /var/www/hotel_management/hotel_management/settings.py

# 2. 收集静态文件
cd /var/www/hotel_management
source venv/bin/activate
python manage.py collectstatic --noinput

# 3. 确认静态文件存在
ls /var/www/hotel_management/staticfiles/admin/simpleui-x/

# 4. 重启服务
systemctl restart nginx
```

---

### 问题 4：配置文件语法错误

**错误信息**：
```
SyntaxError: EOL while scanning string literal
```

**原因**：使用 vi 编辑时意外损坏了文件开头

**解决方案**：
检查 `settings.py` 第一行是否为 `"""`：
```bash
head -1 /var/www/hotel_management/hotel_management/settings.py
```

如果显示异常字符（如 `"y;y;""`），修复：
```bash
sed -i '1s/.*/"""/' /var/www/hotel_management/hotel_management/settings.py
```

---

### 问题 5：collectstatic 报错缺少 STATIC_ROOT

**错误信息**：
```
django.core.exceptions.ImproperlyConfigured: You're using the staticfiles app without having set the STATIC_ROOT setting to a filesystem path.
```

**解决方案**：
在 `settings.py` 中添加：
```python
STATIC_ROOT = os.path.join(BASE_DIR, 'staticfiles')
```

---

## 十三、运维命令速查

### 服务管理

```bash
# 查看服务状态
systemctl status hotel
systemctl status nginx
systemctl status mysqld

# 启动服务
systemctl start hotel
systemctl start nginx

# 停止服务
systemctl stop hotel
systemctl stop nginx

# 重启服务
systemctl restart hotel
systemctl restart nginx

# 查看服务日志
journalctl -u hotel -f
journalctl -u nginx -f
```

### 日志查看

```bash
# Nginx 错误日志
tail -f /var/log/nginx/error.log

# Nginx 访问日志
tail -f /var/log/nginx/access.log

# MySQL 日志
tail -f /var/log/mysqld.log
```

### 项目管理

```bash
# 进入项目目录
cd /var/www/hotel_management

# 激活虚拟环境
source venv/bin/activate

# 收集静态文件
python manage.py collectstatic --noinput

# 数据库迁移
python manage.py migrate

# 创建超级用户
python manage.py createsuperuser

# 手动测试运行
python manage.py runserver 0.0.0.0:8000
```

### 端口检查

```bash
# 查看端口占用
netstat -tlnp | grep 80
netstat -tlnp | grep 8000
netstat -tlnp | grep 3306

# 查看防火墙状态
firewall-cmd --state
firewall-cmd --list-all
```

---

## 部署完成检查清单

- [ ] MySQL 服务正常运行
- [ ] 数据库 `hotel_management_db` 已创建
- [ ] SQL 文件已导入
- [ ] Python 虚拟环境已创建
- [ ] 项目依赖已安装
- [ ] `settings.py` 配置已修改（ALLOWED_HOSTS、数据库密码、STATIC_ROOT）
- [ ] 静态文件已收集（collectstatic）
- [ ] Gunicorn 服务正常运行
- [ ] Nginx 服务正常运行
- [ ] 云服务器安全组已开放 80 端口
- [ ] 可以正常访问 http://117.72.39.127/admin/
- [ ] 可以使用 admin/admin 登录

---

## 作者信息

- **部署日期**：2025年12月14日
- **服务器**：CentOS 7.9
- **项目**：酒店入住管理系统
